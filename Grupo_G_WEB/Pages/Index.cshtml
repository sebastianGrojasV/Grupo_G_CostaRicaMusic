@page
@model IndexModel
@{
    ViewData["Title"] = "Costa Rica Music";
}

<section class="spotify-shell">
    <aside class="sidebar">
        <h1>Costa Rica Music</h1>
        <p class="subtitle">Demo conectada a API</p>

        <h2>Playlists</h2>
        <ul id="playlistList" class="simple-list"></ul>

        <h2>Canciones de la playlist</h2>
        <ul id="playlistSongs" class="simple-list"></ul>
    </aside>

    <main class="main-content">
        <div class="search-card">
            <h2>Búsqueda en catálogo</h2>
            <div class="search-row">
                <input id="searchInput" type="text" placeholder="Buscar canciones..." />
                <button id="searchBtn" type="button" class="action-btn">Buscar</button>
            </div>
            <ul id="searchResults" class="simple-list"></ul>
        </div>

        <div class="player-card">
            <p class="now-playing-label">Ahora sonando</p>
            <h3 id="nowPlayingTitle">Seleccioná una canción</h3>
            <p id="nowPlayingArtist">—</p>
            <audio id="musicPlayer" controls preload="none">
                Tu navegador no soporta audio HTML5.
            </audio>
        </div>
    </main>
</section>

@section Scripts {
    <script>
        const playlistList = document.getElementById('playlistList');
        const playlistSongs = document.getElementById('playlistSongs');
        const searchInput = document.getElementById('searchInput');
        const searchBtn = document.getElementById('searchBtn');
        const searchResults = document.getElementById('searchResults');
        const player = document.getElementById('musicPlayer');
        const title = document.getElementById('nowPlayingTitle');
        const artist = document.getElementById('nowPlayingArtist');

        let selectedPlaylistId = null;

        function createTrackButton(song) {
            const li = document.createElement('li');
            const btn = document.createElement('button');
            btn.type = 'button';
            btn.className = 'track-btn';
            btn.innerHTML = `<span class="track-title">${song.nombreCancion}</span><span class="track-artist">${song.nombreArtista}</span>`;
            btn.addEventListener('click', () => playSong(song.id, song.nombreCancion, song.nombreArtista));
            li.appendChild(btn);
            return li;
        }

        async function playSong(id, songName, artistName) {
            const response = await fetch(`/api/canciones/${id}/reproduccion`);
            if (!response.ok) {
                alert('No fue posible obtener la ruta de reproducción.');
                return;
            }

            const data = await response.json();
            player.src = data.urlReproduccion;
            title.textContent = songName;
            artist.textContent = artistName;
            player.play();
        }

        async function loadPlaylists() {
            const response = await fetch('/api/playlists');
            if (!response.ok) {
                playlistList.innerHTML = '<li>Error al cargar playlists</li>';
                return;
            }

            const playlists = await response.json();
            playlistList.innerHTML = '';

            playlists.forEach((p) => {
                const li = document.createElement('li');
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'playlist-btn';
                btn.textContent = p.nombre;
                btn.addEventListener('click', () => loadPlaylistSongs(p.id));
                li.appendChild(btn);
                playlistList.appendChild(li);
            });

            if (playlists.length > 0) {
                await loadPlaylistSongs(playlists[0].id);
            }
        }

        async function loadPlaylistSongs(playlistId) {
            selectedPlaylistId = playlistId;
            const response = await fetch(`/api/playlists/${playlistId}`);
            if (!response.ok) {
                playlistSongs.innerHTML = '<li>No se pudo cargar la playlist.</li>';
                return;
            }

            const playlist = await response.json();
            playlistSongs.innerHTML = '';

            if (!playlist.canciones || playlist.canciones.length === 0) {
                playlistSongs.innerHTML = '<li>Sin canciones.</li>';
                return;
            }

            playlist.canciones.forEach((song) => {
                const li = createTrackButton(song);
                playlistSongs.appendChild(li);
            });
        }

        async function runSearch() {
            const query = searchInput.value.trim();
            const response = await fetch(`/api/search?tipo=canciones&q=${encodeURIComponent(query)}`);

            if (!response.ok) {
                searchResults.innerHTML = '<li>Error en la búsqueda.</li>';
                return;
            }

            const data = await response.json();
            searchResults.innerHTML = '';

            if (!data.canciones || data.canciones.length === 0) {
                searchResults.innerHTML = '<li>Sin resultados.</li>';
                return;
            }

            data.canciones.forEach((song) => {
                const li = document.createElement('li');
                li.className = 'result-item';

                const trackBtn = document.createElement('button');
                trackBtn.type = 'button';
                trackBtn.className = 'track-btn';
                trackBtn.innerHTML = `<span class="track-title">${song.nombreCancion}</span><span class="track-artist">${song.nombreArtista}</span>`;
                trackBtn.addEventListener('click', () => playSong(song.id, song.nombreCancion, song.nombreArtista));

                const addBtn = document.createElement('button');
                addBtn.type = 'button';
                addBtn.className = 'action-btn';
                addBtn.textContent = '+ Playlist';
                addBtn.addEventListener('click', () => addSongToCurrentPlaylist(song.id));

                li.appendChild(trackBtn);
                li.appendChild(addBtn);
                searchResults.appendChild(li);
            });
        }

        async function addSongToCurrentPlaylist(idCancion) {
            if (!selectedPlaylistId) {
                alert('Primero seleccioná una playlist.');
                return;
            }

            const response = await fetch(`/api/playlists/${selectedPlaylistId}/canciones`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ idCancion })
            });

            if (!response.ok) {
                const err = await response.json();
                alert(err.mensaje || 'No se pudo agregar la canción.');
                return;
            }

            await loadPlaylistSongs(selectedPlaylistId);
        }

        searchBtn.addEventListener('click', runSearch);
        searchInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                runSearch();
            }
        });

        loadPlaylists();
    </script>
}
